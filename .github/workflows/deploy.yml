name: Ship to PyPI & GitHub

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (e.g. v1.0.4)'
        required: true
        type: string

jobs:
  deploy:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    # 1. Checkout Code
    - uses: actions/checkout@v3

    # 2. Setup Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. Install Build Tools
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    # 4. Build C++ Server
    - name: Build RedBoxServer.exe
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release

    # 5. Move EXE to SDK Folder
    - name: Package EXE into SDK
      shell: powershell
      run: |
        if (-not (Test-Path "redbox-sdk/redboxdb")) { mkdir "redbox-sdk/redboxdb" }
        copy "build/src/Release/RedBoxServer.exe" "redbox-sdk/redboxdb/"
        if (-not (Test-Path "redbox-sdk/redboxdb/RedBoxServer.exe")) { 
            Write-Error "EXE copy failed!" 
            exit 1
        }

    # 6. Build Python Wheel
    - name: Build Python Package
      working-directory: ./redbox-sdk
      run: python -m build

    # 7. Fix Wheel Tag for Windows platform
    - name: Fix Wheel Tag
      working-directory: ./redbox-sdk/dist
      shell: powershell
      run: |
        $oldName = Get-ChildItem *.whl | Select-Object -ExpandProperty Name
        $newName = $oldName -replace "none-any", "none-win_amd64"
        Rename-Item $oldName $newName
        echo "WHEEL_PATH=redbox-sdk/dist/$newName" >> $env:GITHUB_ENV

    # 8. Upload to PyPI
    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload ${{ env.WHEEL_PATH }}

    # 9. Upload Assets to GitHub Release Page
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ inputs.version }}
        files: |
          ${{ env.WHEEL_PATH }}
          build/src/Release/RedBoxServer.exe